# 0065: ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸ã®ä½œæˆ

## èª¬æ˜Ž
é–‹ç™ºç’°å¢ƒã‹ã‚‰æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’è©³ç´°ã«æ–‡æ›¸åŒ–ã™ã‚‹ã€‚æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ç’°å¢ƒåˆ¥ã®è¨­å®šã€äº‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ãªã©ã‚’å«ã‚€åŒ…æ‹¬çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †æ›¸ã‚’ä½œæˆã™ã‚‹ã€‚

## ã‚¿ã‚¹ã‚¯ç¨®åˆ¥
- [ ] æ©Ÿèƒ½å®Ÿè£…
- [ ] ãƒã‚°ä¿®æ­£
- [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- [ ] ãƒ†ã‚¹ãƒˆ
- [x] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] èª¿æŸ»

## å„ªå…ˆåº¦
ä¸­

## è¦‹ç©ã‚‚ã‚Šå·¥æ•°
[ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ: 2] (ç´„0.5æ—¥)

## ä¾å­˜é–¢ä¿‚
- å‰æã‚¿ã‚¹ã‚¯: #0059, #0060, #0061
- é–¢é€£ã‚¿ã‚¹ã‚¯: #0066

## å—ã‘å…¥ã‚ŒåŸºæº–
- [ ] ç’°å¢ƒåˆ¥ï¼ˆdev/staging/prodï¼‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ãŒæ˜Žç¢ºã§ã‚ã‚‹
- [ ] äº‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒå®Œå‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ•ãƒ­ãƒ¼ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®è©³ç´°æ‰‹é †ãŒã‚ã‚‹
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ãŒæ˜Žç¢ºã§ã‚ã‚‹
- [ ] ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèªæ‰‹é †ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [ ] ç·Šæ€¥æ™‚ã®å¯¾å¿œæ‰‹é †ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

## æŠ€è¡“çš„ãªè©³ç´°
### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```markdown
# ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸

## 1. æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Open Data APIã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

### å¯¾è±¡ç’°å¢ƒ
- **Development**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
- **Staging**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼ˆVercel Previewï¼‰
- **Production**: æœ¬ç•ªç’°å¢ƒï¼ˆVercel Productionï¼‰

### ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼
- **è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**: GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•åŒ–
- **æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤**: CLIã¾ãŸã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®æ‰‹å‹•å®Ÿè¡Œ

## 2. äº‹å‰æº–å‚™

### 2.1 å¿…è¦ãªãƒ„ãƒ¼ãƒ«
```bash
# Node.js 18ä»¥ä¸Š
node --version

# pnpm 8ä»¥ä¸Š
pnpm --version

# Vercel CLI
npm install -g vercel

# GitHub CLIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
gh --version
```

### 2.2 ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
- [ ] GitHubãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
- [ ] Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
- [ ] Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
- [ ] ç’°å¢ƒå¤‰æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

### 2.3 ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
```bash
# å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
./scripts/deploy/check-env.sh

# çµæžœä¾‹
âœ“ SUPABASE_URL
âœ“ SUPABASE_ANON_KEY
âœ“ SUPABASE_SERVICE_ROLE_KEY
âœ“ VERCEL_TOKEN
âœ— MONITORING_WEBHOOK (optional)
```

## 3. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 3.1 ã‚³ãƒ¼ãƒ‰å“è³ª
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] Lintã‚¨ãƒ©ãƒ¼ãŒãªã„
- [ ] TypeScriptã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒãªã„

```bash
# è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
pnpm run predeploy:check
```

### 3.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ€æ–°ã§ã‚ã‚‹
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

### 3.3 è¨­å®šç¢ºèª
- [ ] ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­å®šãŒé©åˆ‡ã§ã‚ã‚‹
- [ ] CORSã®è¨­å®šãŒæ­£ã—ã„

## 4. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

### 4.1 Stagingã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```yaml
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
# .github/workflows/deploy-staging.yml

1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
2. GitHub ActionsãŒè‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
3. æˆåŠŸã™ã‚‹ã¨Vercel Previewç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãŒPRã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹
```

### 4.2 Productionã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```yaml
# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒžãƒ¼ã‚¸æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
# .github/workflows/deploy-production.yml

1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’mainãƒ–ãƒ©ãƒ³ãƒã«ãƒžãƒ¼ã‚¸
2. GitHub ActionsãŒæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
3. ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé †æ¬¡å®Ÿè¡Œ
4. Slackã«é€šçŸ¥ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
```

## 5. æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

### 5.1 Vercel CLIã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤

#### Stagingç’°å¢ƒ
```bash
# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
vercel

# ç‰¹å®šã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --build-env NODE_ENV=staging

# ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ç¢ºèª
vercel ls
```

#### Productionç’°å¢ƒ
```bash
# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚ã‚Šï¼‰
vercel --prod

# ç’°å¢ƒå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod \
  --build-env NODE_ENV=production \
  --build-env ENABLE_METRICS=true
```

### 5.2 Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤

1. [Vercel Dashboard](https://vercel.com/dashboard)ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠž
3. "Deployments"ã‚¿ãƒ–ã‚’é–‹ã
4. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã‚³ãƒŸãƒƒãƒˆã®"..."ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰"Redeploy"ã‚’é¸æŠž
5. ç’°å¢ƒã‚’é¸æŠžï¼ˆPreview/Productionï¼‰
6. "Redeploy"ã‚’ã‚¯ãƒªãƒƒã‚¯

### 5.3 ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ã‚¹ã‚­ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ããƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
SKIP_TESTS=true vercel --prod --force

# ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod --git-commit=abc123def456
```

## 6. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª

### 6.1 è‡ªå‹•ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
./scripts/deploy/post-deploy-check.sh https://api.example.com

# ãƒã‚§ãƒƒã‚¯é …ç›®
âœ“ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¿œç­”
âœ“ èªè¨¼æ©Ÿèƒ½ã®å‹•ä½œ
âœ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶š
âœ“ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‹•ä½œ
âœ“ ãƒ­ã‚°å‡ºåŠ›
```

### 6.2 æ‰‹å‹•ç¢ºèªé …ç›®
- [ ] ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] ãƒ‡ãƒ¼ã‚¿APIãŒæ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- [ ] ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹

### 6.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç¢ºèª
```bash
# Lighthouse CI
lighthouse https://api.example.com \
  --output=json \
  --output-path=./lighthouse-report.json

# è² è·ãƒ†ã‚¹ãƒˆï¼ˆk6ï¼‰
k6 run ./scripts/load-test/basic.js
```

## 7. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### 7.1 Vercel CLIã§ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’ç¢ºèª
vercel ls

# ç‰¹å®šã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
vercel rollback [deployment-url]

# ä¾‹
vercel rollback https://open-data-api-abc123.vercel.app
```

### 7.2 Gitãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
# å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèª
git log --oneline -10

# revertã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆ
git revert HEAD
git push origin main

# ã¾ãŸã¯ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆã¾ã§æˆ»ã™
git revert abc123..HEAD
git push origin main
```

### 7.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
pnpm run db:rollback

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®ãƒªã‚¹ãƒˆã‚¢
./scripts/backup/restore.sh -d 20250123-020000 -c database
```

## 8. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 8.1 ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã™ã‚‹

#### ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã‚’ç¢ºèª
pnpm run build

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
rm -rf .next node_modules
pnpm install
pnpm run build
```

#### ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼
```bash
# Vercelã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
vercel env ls

# ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
vercel env add VARIABLE_NAME
```

### 8.2 ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å•é¡Œ

#### 500ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
1. Vercelã®ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’ç¢ºèª
2. Supabaseã®æŽ¥ç¶šã‚’ç¢ºèª
3. ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```bash
# ãƒ­ã‚°ã®ç¢ºèª
vercel logs --prod

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
vercel logs --prod --follow
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒé…ã„
1. Edge Functionã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®šã‚’ç¢ºèª
2. ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã®å½±éŸ¿ã‚’èª¿æŸ»
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’ç¢ºèª

### 8.3 ç·Šæ€¥æ™‚ã®å¯¾å¿œ

#### å…¨é¢çš„ãªéšœå®³
1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
2. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
3. åŽŸå› èª¿æŸ»ã‚’é–‹å§‹
4. ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã«é€šçŸ¥

```bash
# ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
./scripts/deploy/emergency-rollback.sh
```

## 9. ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ã®ç®¡ç†

### 9.1 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°
```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’è¨˜éŒ²
cat >> deployments.log << EOF
Date: $(date)
Version: $(git describe --tags)
Commit: $(git rev-parse HEAD)
Deployer: $(git config user.name)
Environment: production
Status: success
EOF
```

### 9.2 ã‚¿ã‚°ä»˜ã‘
```bash
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆ
git tag -a v1.2.3 -m "Release version 1.2.3"
git push origin v1.2.3
```

## 10. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 10.1 ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç«æ›œæ—¥ã€œæœ¨æ›œæ—¥ã®åˆå‰ä¸­ã«å®Ÿæ–½
- é‡‘æ›œæ—¥ã‚„ç¥æ—¥å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯é¿ã‘ã‚‹
- å¤§ããªå¤‰æ›´ã¯æ®µéšŽçš„ã«ãƒªãƒªãƒ¼ã‚¹

### 10.2 ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ãƒãƒ¼ãƒ ã«é€šçŸ¥
- ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«ç¢ºèªã‚’ä¾é ¼
- å•é¡Œç™ºç”Ÿæ™‚ã¯é€Ÿã‚„ã‹ã«å…±æœ‰

### 10.3 ç›£è¦–
- ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ30åˆ†ã¯ç›£è¦–ã‚’å¼·åŒ–
- ã‚¨ãƒ©ãƒ¼çŽ‡ã®å¤‰åŒ–ã‚’æ³¨è¦–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèª
```

### ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/deploy/deploy.sh

set -euo pipefail

# ä½¿ç”¨æ–¹æ³•
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  -e, --env ENV         Target environment (staging|production)"
    echo "  -s, --skip-tests      Skip tests"
    echo "  -f, --force           Force deployment"
    echo "  -h, --help            Show this help message"
    exit 1
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
ENV="staging"
SKIP_TESTS=false
FORCE=false

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æž
while [[ $# -gt 0 ]]; do
    case $1 in
        -e|--env) ENV="$2"; shift 2 ;;
        -s|--skip-tests) SKIP_TESTS=true; shift ;;
        -f|--force) FORCE=true; shift ;;
        -h|--help) usage ;;
        *) echo "Unknown option: $1"; usage ;;
    esac
done

# ç’°å¢ƒã®æ¤œè¨¼
if [[ "$ENV" != "staging" && "$ENV" != "production" ]]; then
    echo "Error: Invalid environment: $ENV"
    exit 1
fi

echo "ðŸš€ Starting deployment to $ENV environment..."

# 1. äº‹å‰ãƒã‚§ãƒƒã‚¯
echo "ðŸ“‹ Running pre-deployment checks..."
if [ "$SKIP_TESTS" = false ]; then
    pnpm run test
    pnpm run lint
    pnpm run type-check
else
    echo "âš ï¸  Skipping tests (not recommended for production)"
fi

# 2. ãƒ“ãƒ«ãƒ‰
echo "ðŸ”¨ Building application..."
pnpm run build

# 3. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
echo "ðŸ” Checking environment variables..."
./scripts/deploy/check-env.sh "$ENV"

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
echo "ðŸš€ Deploying to Vercel..."
if [ "$ENV" = "production" ]; then
    if [ "$FORCE" = true ]; then
        vercel --prod --force
    else
        vercel --prod
    fi
else
    vercel
fi

# 5. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª
echo "âœ… Running post-deployment checks..."
if [ "$ENV" = "production" ]; then
    URL="https://api.example.com"
else
    URL=$(vercel ls --json | jq -r '.[0].url')
fi

./scripts/deploy/post-deploy-check.sh "$URL"

echo "âœ¨ Deployment completed successfully!"
echo "ðŸ”— URL: $URL"

# 6. é€šçŸ¥
if [ "$ENV" = "production" ]; then
    ./scripts/notify-deployment.sh "$URL"
fi
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```typescript
// scripts/deploy/predeploy-check.ts
import { execSync } from 'child_process';
import { readFileSync, existsSync } from 'fs';
import chalk from 'chalk';

interface CheckResult {
  name: string;
  passed: boolean;
  message?: string;
}

class PredeploymentChecker {
  private checks: CheckResult[] = [];

  async runAllChecks(): Promise<boolean> {
    console.log(chalk.blue('ðŸ” Running pre-deployment checks...\n'));

    await this.checkGitStatus();
    await this.checkTests();
    await this.checkBuild();
    await this.checkEnvironmentVariables();
    await this.checkDependencies();
    await this.checkSecurity();

    this.printResults();
    
    return this.checks.every(check => check.passed);
  }

  private async checkGitStatus() {
    try {
      const status = execSync('git status --porcelain').toString();
      const branch = execSync('git branch --show-current').toString().trim();
      
      this.checks.push({
        name: 'Git Status',
        passed: status === '',
        message: status === '' ? 'Working directory clean' : 'Uncommitted changes found',
      });

      this.checks.push({
        name: 'Git Branch',
        passed: branch === 'main' || branch.startsWith('release/'),
        message: `Current branch: ${branch}`,
      });
    } catch (error) {
      this.checks.push({
        name: 'Git Status',
        passed: false,
        message: 'Failed to check git status',
      });
    }
  }

  private async checkTests() {
    try {
      execSync('pnpm run test:unit --silent', { stdio: 'ignore' });
      this.checks.push({
        name: 'Unit Tests',
        passed: true,
        message: 'All tests passed',
      });
    } catch {
      this.checks.push({
        name: 'Unit Tests',
        passed: false,
        message: 'Some tests failed',
      });
    }
  }

  private async checkBuild() {
    try {
      execSync('pnpm run build', { stdio: 'ignore' });
      this.checks.push({
        name: 'Build',
        passed: true,
        message: 'Build successful',
      });
    } catch {
      this.checks.push({
        name: 'Build',
        passed: false,
        message: 'Build failed',
      });
    }
  }

  private async checkEnvironmentVariables() {
    const requiredVars = [
      'SUPABASE_URL',
      'SUPABASE_ANON_KEY',
      'SUPABASE_SERVICE_ROLE_KEY',
      'VERCEL_TOKEN',
    ];

    const missingVars = requiredVars.filter(varName => !process.env[varName]);

    this.checks.push({
      name: 'Environment Variables',
      passed: missingVars.length === 0,
      message: missingVars.length === 0 
        ? 'All required variables set' 
        : `Missing: ${missingVars.join(', ')}`,
    });
  }

  private async checkDependencies() {
    try {
      const output = execSync('pnpm audit --json', { encoding: 'utf8' });
      const audit = JSON.parse(output);
      
      this.checks.push({
        name: 'Dependencies',
        passed: audit.metadata.vulnerabilities.high === 0 && audit.metadata.vulnerabilities.critical === 0,
        message: `${audit.metadata.vulnerabilities.total} vulnerabilities found`,
      });
    } catch {
      this.checks.push({
        name: 'Dependencies',
        passed: true,
        message: 'Audit check skipped',
      });
    }
  }

  private async checkSecurity() {
    const securityPatterns = [
      /console\.log/g,
      /debugger/g,
      /\.env/g,
      /TODO:/gi,
      /FIXME:/gi,
    ];

    let issues = 0;
    // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    
    this.checks.push({
      name: 'Security Scan',
      passed: issues === 0,
      message: issues === 0 ? 'No issues found' : `${issues} potential issues found`,
    });
  }

  private printResults() {
    console.log('\n' + chalk.blue('ðŸ“Š Check Results:'));
    console.log('â”€'.repeat(50));

    this.checks.forEach(check => {
      const status = check.passed 
        ? chalk.green('âœ“') 
        : chalk.red('âœ—');
      const name = check.passed 
        ? chalk.green(check.name) 
        : chalk.red(check.name);
      
      console.log(`${status} ${name}: ${check.message}`);
    });

    console.log('â”€'.repeat(50));

    const passed = this.checks.filter(c => c.passed).length;
    const total = this.checks.length;

    if (passed === total) {
      console.log(chalk.green(`\nâœ… All checks passed (${passed}/${total})`));
    } else {
      console.log(chalk.red(`\nâŒ Some checks failed (${passed}/${total})`));
    }
  }
}

// å®Ÿè¡Œ
if (require.main === module) {
  const checker = new PredeploymentChecker();
  checker.runAllChecks().then(success => {
    process.exit(success ? 0 : 1);
  });
}
```