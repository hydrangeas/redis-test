# 0060: Vercelãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

## èª¬æ˜
Vercelãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨Serverless Functionsã®è¨­å®šã‚’å®Ÿè£…ã™ã‚‹ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIï¼ˆFastifyï¼‰ã®ä¸¡æ–¹ã‚’Vercel Edge Functionsã¨ã—ã¦æœ€é©åŒ–ã—ã€è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ã€ç’°å¢ƒå¤‰æ•°ç®¡ç†ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šãªã©ã‚’å«ã‚€æœ¬ç•ªç’°å¢ƒå¯¾å¿œã®æ§‹æˆã‚’ç¢ºç«‹ã™ã‚‹ã€‚

## ã‚¿ã‚¹ã‚¯ç¨®åˆ¥
- [x] æ©Ÿèƒ½å®Ÿè£…
- [ ] ãƒã‚°ä¿®æ­£
- [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- [ ] ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] èª¿æŸ»

## å„ªå…ˆåº¦
é«˜

## è¦‹ç©ã‚‚ã‚Šå·¥æ•°
[ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ: 3] (ç´„1æ—¥)

## ä¾å­˜é–¢ä¿‚
- å‰æã‚¿ã‚¹ã‚¯: #0001, #0049, #0059
- é–¢é€£ã‚¿ã‚¹ã‚¯: #0061, #0062

## å—ã‘å…¥ã‚ŒåŸºæº–
- [x] Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
- [x] Fastifyãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒServerless Functionsã¨ã—ã¦å‹•ä½œã™ã‚‹
- [x] ç’°å¢ƒå¤‰æ•°ãŒå®‰å…¨ã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ©Ÿèƒ½ã™ã‚‹
- [x] ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨­å®šå¯èƒ½ã§ã‚ã‚‹
- [x] Edge Functionsã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ãƒƒã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

## æŠ€è¡“çš„ãªè©³ç´°
### Vercelè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
```json
// vercel.json
{
  "framework": null,
  "buildCommand": "pnpm run build",
  "outputDirectory": "packages/frontend/dist",
  "installCommand": "pnpm install",
  "devCommand": "pnpm run dev",
  "regions": ["hnd1"],
  "functions": {
    "api/index.js": {
      "runtime": "nodejs18.x",
      "maxDuration": 10,
      "memory": 1024,
      "regions": ["hnd1"]
    }
  },
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "/api"
    },
    {
      "source": "/secure/:path*",
      "destination": "/api"
    },
    {
      "source": "/auth/:path*",
      "destination": "/api"
    },
    {
      "source": "/health",
      "destination": "/api"
    },
    {
      "source": "/api-docs",
      "destination": "/api"
    },
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ],
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "s-maxage=60, stale-while-revalidate=300"
        }
      ]
    },
    {
      "source": "/secure/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "private, no-cache, no-store, must-revalidate"
        }
      ]
    }
  ],
  "env": {
    "VITE_SUPABASE_URL": "@supabase-url",
    "VITE_SUPABASE_ANON_KEY": "@supabase-anon-key",
    "VITE_API_URL": "@api-url"
  }
}
```

### Fastify Edge Function ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
```typescript
// api/index.js
import { createServer } from '@vercel/node';
import app from '../packages/backend/dist/app.js';

// Vercel Edge Functionç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
export default createServer(async (req, res) => {
  // Fastifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
  const fastify = await app({
    logger: {
      level: process.env.LOG_LEVEL || 'info',
      serializers: {
        req: (req) => ({
          method: req.method,
          url: req.url,
          headers: req.headers,
        }),
        res: (res) => ({
          statusCode: res.statusCode,
        }),
      },
    },
  });

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
  await fastify.ready();
  fastify.server.emit('request', req, res);
});

// Edge Runtimeè¨­å®š
export const config = {
  runtime: 'edge',
  regions: ['hnd1'], // æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
};
```

### Edge Functionsæœ€é©åŒ–
```typescript
// packages/backend/src/adapters/vercel.ts
import type { FastifyInstance } from 'fastify';
import type { VercelRequest, VercelResponse } from '@vercel/node';

export class VercelAdapter {
  constructor(private app: FastifyInstance) {}

  async handleRequest(req: VercelRequest, res: VercelResponse) {
    // Vercelã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›
    const url = `https://${req.headers.host}${req.url}`;
    const headers: Record<string, string> = {};
    
    for (const [key, value] of Object.entries(req.headers)) {
      if (typeof value === 'string') {
        headers[key] = value;
      }
    }

    // Fastifyãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
    const response = await this.app.inject({
      method: req.method as any,
      url,
      headers,
      payload: req.body,
    });

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¿”å´
    res.status(response.statusCode);
    
    for (const [key, value] of Object.entries(response.headers)) {
      res.setHeader(key, value as string);
    }
    
    res.send(response.body);
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
  getCacheHeaders(path: string): Record<string, string> {
    // é™çš„ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    if (path.startsWith('/secure/') && path.endsWith('.json')) {
      return {
        'Cache-Control': 'public, max-age=300, s-maxage=3600, stale-while-revalidate=86400',
        'CDN-Cache-Control': 'max-age=3600',
      };
    }

    // èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
    if (path.startsWith('/auth/')) {
      return {
        'Cache-Control': 'private, no-cache, no-store, must-revalidate',
      };
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    return {
      'Cache-Control': 'public, max-age=60, s-maxage=300',
    };
  }
}
```

### ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–è¨­å®š
```typescript
// packages/backend/vite.config.ts
import { defineConfig } from 'vite';
import { nodeResolve } from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';

export default defineConfig({
  build: {
    target: 'node18',
    ssr: true,
    rollupOptions: {
      input: 'src/index.ts',
      output: {
        format: 'esm',
        entryFileNames: 'app.js',
      },
      external: [
        // Vercel Edge Runtimeã§æä¾›ã•ã‚Œã‚‹ä¾å­˜é–¢ä¿‚
        '@vercel/node',
        'node:crypto',
        'node:stream',
        'node:buffer',
      ],
    },
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: process.env.NODE_ENV === 'production',
      },
    },
  },
  plugins: [
    nodeResolve({
      preferBuiltins: true,
    }),
    commonjs(),
  ],
});
```

### ç’°å¢ƒå¤‰æ•°ç®¡ç†
```typescript
// packages/backend/src/config/vercel-env.ts
import { z } from 'zod';

const vercelEnvSchema = z.object({
  // Vercelæä¾›ã®ç’°å¢ƒå¤‰æ•°
  VERCEL: z.string().optional(),
  VERCEL_ENV: z.enum(['production', 'preview', 'development']).optional(),
  VERCEL_URL: z.string().optional(),
  VERCEL_REGION: z.string().optional(),
  
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°
  SUPABASE_URL: z.string().url(),
  SUPABASE_SERVICE_ROLE_KEY: z.string(),
  SUPABASE_ANON_KEY: z.string(),
  
  // æ©Ÿèƒ½ãƒ•ãƒ©ã‚°
  ENABLE_RATE_LIMIT: z.string().transform(v => v === 'true').default('true'),
  RATE_LIMIT_REDIS_URL: z.string().optional(),
});

export function loadVercelEnv() {
  const env = vercelEnvSchema.parse(process.env);
  
  // Vercelç’°å¢ƒã«å¿œã˜ãŸè¨­å®š
  const isProduction = env.VERCEL_ENV === 'production';
  const isPreview = env.VERCEL_ENV === 'preview';
  
  return {
    ...env,
    isProduction,
    isPreview,
    isDevelopment: !env.VERCEL_ENV || env.VERCEL_ENV === 'development',
    baseUrl: env.VERCEL_URL ? `https://${env.VERCEL_URL}` : 'http://localhost:3000',
  };
}
```

### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
```bash
# .vercelignore
# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
**/*.test.ts
**/*.spec.ts
**/test/**
**/tests/**
**/__tests__/**

# é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«
.env.local
.env.development
.env.test

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
docs/
*.md

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚’ä½¿ç”¨ï¼‰
packages/*/src/

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
.eslintrc*
.prettierrc*
vitest.config.ts
playwright.config.ts
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ãƒƒã‚¯
```typescript
// scripts/vercel-deploy-hook.ts
import { execSync } from 'child_process';

interface DeploymentEvent {
  type: 'deployment' | 'deployment-ready' | 'deployment-error';
  payload: {
    url: string;
    name: string;
    meta: {
      githubCommitSha: string;
      githubCommitMessage: string;
      githubCommitAuthorName: string;
    };
  };
}

export async function handleDeploymentHook(event: DeploymentEvent) {
  switch (event.type) {
    case 'deployment-ready':
      // ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã®å‡¦ç†
      console.log(`Deployment ready: ${event.payload.url}`);
      
      // Lighthouseãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      if (process.env.RUN_LIGHTHOUSE === 'true') {
        execSync(`lighthouse ${event.payload.url} --output=json --output-path=./lighthouse-report.json`);
      }
      
      // Slackã¸ã®é€šçŸ¥
      if (process.env.SLACK_WEBHOOK_URL) {
        await notifySlack({
          text: `ğŸš€ Deployment successful!`,
          attachments: [{
            color: 'good',
            fields: [
              { title: 'URL', value: event.payload.url },
              { title: 'Commit', value: event.payload.meta.githubCommitSha.slice(0, 7) },
              { title: 'Message', value: event.payload.meta.githubCommitMessage },
              { title: 'Author', value: event.payload.meta.githubCommitAuthorName },
            ],
          }],
        });
      }
      break;
      
    case 'deployment-error':
      // ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
      console.error(`Deployment failed: ${event.payload.name}`);
      break;
  }
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
```typescript
// packages/backend/src/plugins/vercel-analytics.ts
import fp from 'fastify-plugin';
import { FastifyInstance } from 'fastify';

export default fp(async function vercelAnalytics(fastify: FastifyInstance) {
  // Vercel Analyticsç”¨ã®ãƒ‡ãƒ¼ã‚¿åé›†
  fastify.addHook('onRequest', async (request, reply) => {
    request.startTime = Date.now();
  });

  fastify.addHook('onResponse', async (request, reply) => {
    const duration = Date.now() - request.startTime;
    
    // Vercel Analyticsã«é€ä¿¡
    if (process.env.VERCEL_ANALYTICS_ID) {
      // Web Vitalsã®è¨˜éŒ²
      reply.header('Server-Timing', `total;dur=${duration}`);
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨˜éŒ²
    fastify.log.info({
      method: request.method,
      url: request.url,
      statusCode: reply.statusCode,
      duration,
      region: process.env.VERCEL_REGION,
    });
  });
});
```

### ãƒ¢ãƒãƒ¬ãƒå¯¾å¿œè¨­å®š
```json
// packages/frontend/vercel.json
{
  "builds": [
    {
      "src": "packages/frontend/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "packages/frontend/dist"
      }
    },
    {
      "src": "packages/backend/package.json",
      "use": "@vercel/node",
      "config": {
        "includeFiles": [
          "packages/backend/dist/**"
        ]
      }
    }
  ]
}
```